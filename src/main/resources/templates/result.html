<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head lang="en">

    <title>MultiGenBrowser</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link rel="stylesheet" media="screen" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" media="screen" href="../static/css/result.css" th:href="@{/css/result.css}" />

    <script src="../static/js/plotly-latest.min.js" th:href="@{/js/plotly-latest.min.js}" ></script>
    <script src="../static/js/jquery-1.12.0.min.js" th:href="@{/js/jquery-1.12.0.min.js}" ></script>
    <script src="../static/js/bootstrap.min.js" th:href="@{/js/bootstrap.min.js}" ></script>


</head>
<body>

    <div th:include="header:: bar"></div>

<div class="col-sm-3 col-md-2 sidebar">

  <div th:include="upload:: upload"></div>

  <div class="box">
      <h4>Assembly</h4>
      <select class="form-control">
          <option>hg19</option>
          <option>hg38</option>
      </select>
  </div>

  <div class="box">
      <h4>Cell Line</h4>
      <select id="cellline" class="form-control" name="assembly" form="covariant_form">
          <option value="none">None</option>
          <option value="hela">HeLa</option>
          <option value="hesc">hESC</option>
      </select>
  </div>

  <div class="box">
    <h4> Track packages </h4>

    <div class="checkbox">
      <label><input type="checkbox" value="basic" form="covariant_form" checked>Basic</label>
    </div>
    <div class="checkbox">
      <label><input type="checkbox" value="expression" form="covariant_form" checked>Expression</label>
    </div>
    <div class="checkbox">
      <label><input type="checkbox" value="histone" form="covariant_form" >Histone modifications</label>
    </div>
  </div>

    <h4>Information</h4>

    <div class="fileinfo">
            <p th:text="${'Current File: ' + covariantCommand.originalFilename}"></p>
            <span>Positions</span><span class="file_positions" th:text="${covariantCommand.positionCount}"></span>
    </div>

    <div class="fileinfo">
            <a href="export/bg"><span>Background Positions:</span></a><input type="number" step="200" th:value="${bgCount}">
    </div>

    <th:block th:if="${#lists.isEmpty(results_inout)}">
        <button id="rerun" type="submit" class="btn btn-default" form="covariant_form">Run again</button>
    </th:block>
    <th:block th:if="${not #lists.isEmpty(results_inout)}">
        <button id="rerun" type="submit" class="btn btn-primary" form="covariant_form">Run again</button>
    </th:block>

    <div>
        <a class="btn btn-default extra-margin" href="export/pdf">Export pdf</a>
        <a class="btn btn-default extra-margin" href="export/csv">Export csv</a>
        <br>
        <a class="btn btn-default extra-margin" href="clear_session">Clear session</a>
    </div>

</div>


<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">

    <div class="container row col-md-12">

        <div id="error" th:text="${errorMessage}" class="bg-danger"></div>


        <div class="col-md-8 ">

        <form method="POST" action="#" th:action="@{/covariant}" th:object="${covariantCommand}" id="covariant_form"></form>

            <input type="hidden" th:value="${covariantCommand.originalFilename}" th:field="${covariantCommand.originalFilename}" form="covariant_form">
            <table class="table table-hover fixed">

                <col width="160px" />
                <col width="50px" />
                <col width="70px" />
                <col width="150px" />
                <col width="30px" />


                <thead>
                    <th th:text="${'Significant tracks' + ' (' + sigTrackCount + '/' + trackCount + ')'}" data-toggle="tooltip" data-placement="right" title="Count of significant tracks vs all tracks">Significant Tracks</th>

                    <th data-toggle="tooltip" data-placement="right" title="P-value computed by chi-square-test">P Value</th>
                    <th>Effect Size</th>
                    <th>Plot<span style="font-size: 10px;"> <span style="color: #337ab7; font-size: 13px;">Data</span> vs. <span style="color: #555; font-size: 13px;"> Background</span></span></th>
                    <th>Covariant</th>
                </thead>
                <tbody>


                <th:block th:each="result: ${results_inout}">
                    <tr >
                        <td th:text="${result.name}" th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}" data-toggle="collapse" class="accordion-toggle" ></td>
                        <td th:text="${result.pValue}"></td>
                        <td th:text="${result.effectSize}"></td>
                        <td class="bars">
                            <div class="bar measured" th:style="'width: ' + ${result.percentInM} + '%;'"></div>
                            <div class="bar expected" th:style="'width: ' + ${result.percentInE} + '%;'"></div>
                        </td>
                        <td><input th:field="*{covariantCommand.covariants}" th:value="${result.id}" type="checkbox" form="covariant_form"></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse" th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                <div>
                                    <table class="table">
                                        <thead>
                                            <th></th>
                                            <th class="bold">In</th>
                                            <th class="bold">Out</th>
                                        </thead>
                                        <tr class="">
                                            <td class="bold" th:text="${covariantCommand.originalFilename}"></td>
                                            <td th:text="${result.measuredIn + ' (' + result.percentInM + '%)'}"></td>
                                            <td th:text="${result.measuredOut+ ' (' + result.percentOutM+ '%)'}"></td>
                                        </tr>
                                        <tr class="">
                                            <td class="bold">Background</td>
                                            <td th:text="${result.expectedIn+ ' (' + result.percentInE + '%)'}"></td>
                                            <td th:text="${result.expectedOut+ ' (' + result.percentOutE+ '%)'}"></td>
                                        </tr>
                                    </table>
                                </div>
                                <div th:text="${result.description}"></div>
                            </div>
                        </td>
                    </tr>

                </th:block>
                <tr>
                    <td class="add" colspan="5" data-placement="right" title="Create or upload custom track" data-toggle="tooltip">
                        <button type="button" class="btn btn-default" data-toggle="modal"  data-target="#add_track">
                            &#43;
                        </button>
                    </td>
                </tr>

                <th:block th:each="result: ${results_score}">
                    <tr th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}" data-toggle="collapse" class="accordion-toggle">
                        <td th:text="${result.name}"></td>
                        <td th:text="${result.pValue}"></td>
                        <td th:text="${result.effectSize}"></td>
                        <td th:id="${'plot_'+result.id}"></td>
                        <td><input th:field="*{covariantCommand.covariants}" th:value="${result.id}" type="checkbox" form="covariant_form"></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse" th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                <div th:text="${result.description}"></div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                <th:block th:each="result: ${results_named}">
                    <tr th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}" data-toggle="collapse" class="accordion-toggle">
                        <td th:text="${result.name}"></td>
                        <td th:text="${result.pValue}"></td>
                        <td th:text="${result.effectSize}"></td>
                        <td th:id="${result.id}"></td>
                        <td><input th:field="*{covariantCommand.covariants}" th:value="${result.id}" type="checkbox" form="covariant_form"></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse" th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                <div class="nameplot" th:id="${'nameplot_'+result.id}">
                                    <div th:value="${result.namesMea}"></div>
                                    <div th:value="${result.namesExp}"></div>
                                </div>
                                <div th:text="${result.description}"></div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                </tbody>
            </table>

        </div>
        <div class="col-md-4">

            <table class="table table-hover fixed">

                <col width="400px" />
                <col width="30px" />
                <thead>
                    <th th:text="${'Covariants' + ' (' + covariantCount + ')'}">Covariants</th>
                    <th>Mark</th>
                </thead>
                <tbody>
                    <th:block th:each="cov: ${covariants}">
                        <tr>
                           <td th:text="${cov.name}" th:attr="data-target=${#strings.replace('#accordion_cov_' + cov.id,'.','_')}" data-toggle="collapse" class="accordion-toggle" ></td>
                           <td><input th:field="*{covariantCommand.covariants}" th:value="${cov.id}" type="checkbox" form="covariant_form" class="checked" checked></td>
                        </tr>
                        <tr>
                          <td colspan="2" class="hiddenRow">
                            <div class="accordion-body collapse" th:id="${#strings.replace('accordion_cov_' + cov.id,'.','_')}">
                                <div>
                                    <div>
                                        <table class="table">


                                            <thead>
                                                <th></th>
                                                <th class="bold">In</th>
                                                <th class="bold">Out</th>
                                            </thead>
                                            <tr class="">
                                                <td class="bold" th:text="${covariantCommand.originalFilename}"></td>
                                                <td th:text="${cov.measuredIn + ' (' + cov.percentInM + '%)'}"></td>
                                                <td th:text="${cov.measuredOut+ ' (' + cov.percentOutM+ '%)'}"></td>
                                            </tr>
                                            <tr class="">
                                                <td class="bold">Background</td>
                                                <td th:text="${cov.expectedIn+ ' (' + cov.percentInE + '%)'}"></td>
                                                <td th:text="${cov.expectedOut+ ' (' + cov.percentOutE+ '%)'}"></td>
                                            </tr>
                                            <tr>
                                                <td>P Value</td>
                                                <td th:text="${cov.pValue}"></td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" th:id="${cov.id}"></td>
                                                <td colspan="3" th:id="${'plot_'+cov.id}"></td>
                                            </tr>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </td>


                        </tr>


                    </th:block>

                </tbody>

            </table>

        </div>

    </div><!-- /.container -->

    <!-- Modal for add/upload track -->
    <div th:include="add_track:: add_track"></div>


</div>
    <script>
        $(function () {
          $('[data-toggle="tooltip"]').tooltip({
              container: 'body'

          });
        });

        $('.checked').prop('checked', true);

    </script>

<script th:inline="javascript" async>
/*<![CDATA[*/
    'use strict';


    plotNames([[${results_named}]]);

    function plotNames(results) {

        for(var j = 0; j < results.length; j++ ){
            var result = results[j];

            var x1= [];
            for(var key in result.namesExp) {
                x1.push(result.namesExp[key]/[[${bgCount}]]);
            }

            var x2= [];
            for(var key2 in result.namesMea) {
                x2.push(result.namesMea[key2]/[[${covariantCommand.positionCount}]]);
            }




            var trace1 = {
              x: Object.keys(result.namesExp),
              y: x1,
              name: 'Expected',
              type: 'bar',
              marker: {color: 'rgb(85,85,85)'},
            };

            var trace2 = {
              x: Object.keys(result.namesMea),
              y: x2,
              name: 'Measured',
              type: 'bar',
              marker: {color: 'rgb(51,122,183)'},
            };

            var data = [trace1, trace2];

            var layout = {
              width: 600,
              height: 200,
              barmode: 'group',
              xaxis: {
                autorange: true,
                showgrid: false,
                zeroline: true,
                showline: false,
                autotick: true,
                ticks: '',
                showticklabels: false
              },
              yaxis: {
                autorange: true,
                showgrid: false,
                zeroline: false,
                showline: false,
                autotick: true,
                ticks: '',
                showticklabels: false
              },
              margin: { l: 20, r: 20, b: 40, t: 0, pad: 0 },
              showlegend: false,
              barnorm:"fraction"
            };
            Plotly.newPlot('nameplot_' + result.id, data, layout);
        }
    }


    plot([[${results_score}]]);
    plot([[${covariants}]]);

    function plot(results) {
        var buttons_s = {};

        for(var j = 0; j < results.length; j++ ){
            //if(results[j].resultMeasured.type != "score"){ break; }

            var x0 = results[j].scoresMea;
            var x1 = results[j].scoresExp;

            var measured = {
              x: x0,
              marker: {color: 'rgb(51,122,183)'},
              opacity: 0.75,
              type: 'histogram',
              name: "measured"
            };

            var expected = {
              x: x1,
              opacity: 0.75,
              marker: {color: 'rgb(85,85,85)'},
              type: 'histogram',
              name: "expected"
            };
            var data_s = [measured, expected];

            var layout_s = {
              autosize: false,
              width: 400,
              height: 100,
              barmode: 'overlay',
              xaxis: {
                autorange: true,
                showgrid: true,
                zeroline: true,
                showline: false,
                autotick: true,
                ticks: ''
              },
              yaxis: {
                autorange: true,
                showgrid: false,
                zeroline: false,
                showline: false,
                autotick: true,
                ticks: '',
                showticklabels: false
              },
              margin: { l: 0, r: 0, b: 15, t: 0, pad: 0 }
            };
            Plotly.newPlot("plot_" + results[j].id, data_s, layout_s, buttons_s);

        }
    }

/*]]>*/
</script>

</body>
</html>