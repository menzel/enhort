<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">

<head lang="en">

    <title>Enhort</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link rel="stylesheet" media="screen" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" media="screen" href="../static/css/result.css" th:href="@{/css/result.css}"/>

    <script src="/js/plotly-latest.min.js" th:href="@{/js/plotly-latest.min.js}"></script>
    <script src="/js/jquery-1.12.0.min.js" th:href="@{/js/jquery-1.12.0.min.js}"></script>
    <script src="/js/bootstrap.min.js" th:href="@{/js/bootstrap.min.js}"></script>
    <script src="/js/d3.min.js" th:href="@{/js/d3.min.js}"></script>

</head>
<body>

<div th:include="header:: bar"></div>

<div class="col-xs-2 col-sm-3 col-md-2 sidebar">

    <th:block th:if="${ran == null}">
        <div th:include="upload:: upload"></div>
    </th:block>

    <th:block th:if="${ran}">

            <div class="box">
                <h4>Assembly</h4>
                <select id="assembly" class="form-control" name="assembly" form="covariant_form">
                    <option th:value="${interfaceCommand.assembly}" th:text="${interfaceCommand.assembly}"></option>
                    <option value="hg19">hg19</option>
                    <option value="hg38">hg38</option>
                </select>
            </div>


            <div class="box">
                <h4>Cell Line</h4>
                <select id="cellline" class="form-control" name="cellline" form="covariant_form">
                    <option value="none">None</option>
                    <option value="hela">HeLa</option>
                    <option value="hesc">hESC</option>
                </select>
            </div>



    <div class="box">
        <h4> Track packages </h4>

        <th:block th:each="packName: ${trackPackages}">
            <div class="checkbox">
                <label><input type="checkbox" th:field="*{interfaceCommand.packageNames}" th:value="${packName}"
                              form="covariant_form" checked="checked" th:text="${packName}"/></label>
            </div>
        </th:block>

        <h4> Custom tracks </h4>

        <th:block th:each="track: ${customTracks}">
            <div class="checkbox">
                <span th:text="${track.name}"></span>
            </div>
        </th:block>

    </div>

    <h4>Information</h4>


    <div class="fileinfo">
        <p th:text="${'Current File: ' + interfaceCommand.originalFilename}"></p>
        <span>Positions</span><span class="file_positions" th:text="${interfaceCommand.positionCount}"></span>
    </div>


    <div class="fileinfo">
        <p>
            <a href="export/bg"><span>Bg Positions:</span></a> <input type="number" step="200" th:value="${bgCount}"
                                                                      form="covariant_form"
                                                                      th:field="*{interfaceCommand.minBg}"/>
        </p>
        <p>
            <span>Influence:</span> <input type="number" step="0.1" th:value="${interfaceCommand.influence}"
                                           form="covariant_form" style="margin-left: 28px"
                                           th:field="*{interfaceCommand.influence}"/>
        </p>
    </div>

    </th:block>

    <th:block th:if="${ran == null}">
        <button id="rerun" type="submit" class="btn btn-default" form="covariant_form" disabled="disabled">Run again
        </button>
    </th:block>
    <th:block th:if="${ran}">
        <button id="rerun" type="submit" class="btn btn-primary" form="covariant_form">Run again</button>
    </th:block>


    <a class="btn btn-default extra-margin" href="export/csv" id="save">
        <span class="glyphicon glyphicon-save-file" aria-hidden="true"></span>
    </a>

    <a class="btn btn-default bottom" href="clear_session" id="clear">Clear session</a>

</div>


<div class="col-xs-10 col-xs-offset-2 col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">

    <div class="container row col-md-12">

        <div id="error" th:text="${errorMessage}" class="bg-danger"></div>

        <div class="col-md-8 ">

            <form method="POST" action="#" th:action="@{/covariant}" th:object="${interfaceCommand}"
                  id="covariant_form"></form>

            <table class="table table-hover fixed">

                <col width="160px"/>
                <col width="50px"/>
                <col width="70px"/>
                <col width="150px"/>
                <col width="30px"/>


                <thead>
                <th th:text="${'Significant tracks' + ' (' + sigTrackCount + '/' + trackCount + ')'}"
                    data-toggle="tooltip" data-placement="right" title="Count of significant tracks vs all tracks">
                    Significant Tracks
                </th>

                <th data-toggle="tooltip" data-placement="right" title="P-value computed by chi-square-test">P Value
                </th>
                <th>Effect Size</th>
                <th>Relative Integration<span style="font-size: 10px;"> <span style="color: #337ab7; font-size: 13px;">Data</span> vs. <span
                        style="color: #555; font-size: 13px;"> Background</span></span></th>
                </thead>
                <tbody>

                <!-- Sequencelogo Entry -->
                <th:block th:if="${ran}">
                    <tr data-target="#sequencelogodiv" data-toggle="collapse" class="accordion-toggle">
                        <td> Sequence Logo</td>
                        <td></td>
                        <td th:text="${sl_effect}"></td>
                        <td colspan="1"></td>
                        <td><input th:field="${interfaceCommand.logoCovariate}" type="checkbox" form="covariant_form"/></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse" id="sequencelogodiv">

                                <div id="sequencelogo"></div>
                                The Sequence or Weblogo with a width of 12 bases of 3000 sequences taken from the
                                dataset.
                            </div>
                        </td>
                    </tr>

                </th:block>
                <!-- Sequencelogo Entry END -->


                <th:block th:each="result: ${results_inout}">
                    <tr>
                        <td th:text="${result.name}"
                            th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}"
                            data-toggle="collapse" class="accordion-toggle"></td>
                        <td th:text="${result.pValue}"></td>
                        <td th:text="${result.effectSize}"></td>
                        <td class="bars">
                            <div class="bar measured" th:style="'width: ' + ${result.percentInM} + '%;'"></div>
                            <div class="bar expected" th:style="'width: ' + ${result.percentInE} + '%;'"></div>
                        </td>
                        <td><input th:field="*{interfaceCommand.covariants}" th:value="${result.id}" type="checkbox"
                                   form="covariant_form"/></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse"
                                 th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                <div>
                                    <table class="table">
                                        <thead>
                                        <th></th>
                                        <th class="bold">In</th>
                                        <th class="bold">Out</th>
                                        </thead>
                                        <tr class="">
                                            <td class="bold" th:text="${interfaceCommand.originalFilename}"></td>
                                            <td th:text="${result.measuredIn + ' (' + result.percentInM + '%)'}"></td>
                                            <td th:text="${result.measuredOut+ ' (' + result.percentOutM+ '%)'}"></td>
                                        </tr>
                                        <tr class="">
                                            <td class="bold">Background</td>
                                            <td th:text="${result.expectedIn+ ' (' + result.percentInE + '%)'}"></td>
                                            <td th:text="${result.expectedOut+ ' (' + result.percentOutE+ '%)'}"></td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="desc" th:text="${result.description}"></div>
                            </div>
                        </td>
                    </tr>

                </th:block>

                <th:block th:if="${ran}">
                    <tr> <!-- create or upload custom track button -->
                        <td class="add" colspan="5" data-placement="right" title="Upload custom track"
                            data-toggle="tooltip">
                            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#add_track">
                                &#43;
                            </button>
                        </td>
                    </tr>
                </th:block>

                <th:block th:each="result: ${results_score}">
                    <tr th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}"
                        data-toggle="collapse" class="accordion-toggle">
                        <td th:text="${result.name}"></td>
                        <td th:text="${result.pValue}"></td>
                        <td th:text="${result.effectSize}"></td>
                        <td th:id="${'plot_'+result.id}"></td>
                        <th:block th:if="${not #strings.startsWith(result.name,'FOOBAR Distance from')}">
                            <!-- only display a checkbox for covariates if it is not a _distance_ track -->
                            <td><input th:field="*{interfaceCommand.covariants}" th:value="${result.id}" type="checkbox"
                                       form="covariant_form"/></td>
                        </th:block>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse"
                                 th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                <div class="desc" th:text="${result.description}"></div>
                            </div>
                        </td>
                    </tr>
                </th:block>
                <th:block th:each="result: ${results_named}">
                    <tr th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}"
                        data-toggle="collapse" class="accordion-toggle">
                        <td th:text="${result.name}"></td>
                        <td th:text="${result.pValue}"></td>
                        <td th:text="${result.effectSize}"></td>
                        <td th:id="${result.id}"></td>
                        <td><input th:field="*{interfaceCommand.covariants}" th:value="${result.id}" type="checkbox"
                                   form="covariant_form"/></td>
                    </tr>
                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse"
                                 th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                <div class="nameplot" th:id="${'nameplot_'+result.id}">
                                    <div th:value="${result.namesMea}"></div>
                                    <div th:value="${result.namesExp}"></div>
                                </div>
                                <div class="desc" th:text="${result.description}"></div>
                            </div>
                        </td>
                    </tr>
                </th:block>


                </tbody>
            </table>

        </div>
        <div class="col-md-4">

            <table class="table table-hover fixed">

                <col width="400px"/>
                <col width="30px"/>
                <thead>
                <th th:text="${'Covariates' + ' (' + covariantCount + ')'}">Covariates</th>
                </thead>
                <tbody>
                <th:block th:each="cov: ${covariants}">
                    <tr>
                        <td th:text="${cov.name}"
                            th:attr="data-target=${#strings.replace('#accordion_cov_' + cov.id,'.','_')}"
                            data-toggle="collapse" class="accordion-toggle"></td>
                        <td><input th:field="*{interfaceCommand.covariants}" th:value="${cov.id}" type="checkbox"
                                   form="covariant_form" class="checked" checked="checked"/></td>
                    </tr>
                    <tr>
                        <td colspan="2" class="hiddenRow">
                            <div class="accordion-body collapse"
                                 th:id="${#strings.replace('accordion_cov_' + cov.id,'.','_')}">
                                <div>
                                    <div>
                                        <table class="table">


                                            <thead>
                                            <th></th>
                                            <th class="bold">In</th>
                                            <th class="bold">Out</th>
                                            </thead>
                                            <tr class="">
                                                <td class="bold" th:text="${interfaceCommand.originalFilename}"></td>
                                                <td th:text="${cov.measuredIn + ' (' + cov.percentInM + '%)'}"></td>
                                                <td th:text="${cov.measuredOut+ ' (' + cov.percentOutM+ '%)'}"></td>
                                            </tr>
                                            <tr class="">
                                                <td class="bold">Background</td>
                                                <td th:text="${cov.expectedIn+ ' (' + cov.percentInE + '%)'}"></td>
                                                <td th:text="${cov.expectedOut+ ' (' + cov.percentOutE+ '%)'}"></td>
                                            </tr>
                                            <tr>
                                                <td>P Value</td>
                                                <td th:text="${cov.pValue}"></td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" th:id="${cov.id}"></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" th:id="${'plot_'+cov.id}"></td>
                                            </tr>
                                            <tr>
                                                <td colspan="3" th:id="${'nameplot_'+cov.id}"></td>
                                            </tr>
                                        </table>

                                    </div>
                                </div>
                            </div>
                        </td>


                    </tr>


                </th:block>

                </tbody>

            </table>

        </div>


    </div><!-- /.container -->

    <!-- Modal for add/upload track -->
    <div th:include="add_track:: add_track"></div>


    <th:block th:if="${ran == null}">
        <div id="new" class="bg-info">
            <h3> New to Enhort? </h3>
            <p>Go to <a href="/faq">FAQ</a> and find out how to work with the application.</p>

            <p>If you know what you are doing upload a file and get started.</p>

        </div>
    </th:block>

</div>
<script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip({
            container: 'body'

        });
    });

    $('.checked').prop('checked', true);

</script>

<script th:inline="javascript" async="async">
    /*<![CDATA[*/
    'use strict';


    plotNames([[${results_named}]]);
    plotNames([[${covariants}]]);

    function plotNames(results) {

        for (var j = 0; j < results.length; j++) {
            var result = results[j];


            var y1 = [];
            var y2 = [];

            for (var key in result.namesExp) {

                if(result.namesMea.hasOwnProperty(key)) {
                    var effectSize = result.namesExp[key] / result.namesMea[key];

                    if(effectSize >=  1.2 || effectSize <= 0.7) {
                        y1.push(result.namesExp[key] / [[${bgCount}]]);
                        y2.push(result.namesMea[key] / [[${interfaceCommand.positionCount}]]);
                    }
                }
            }


            if (y1.length < 2 || y1.length > 1000) {
                continue;
            }

            var trace1 = {
                x: Object.keys(result.namesExp),
                y: y1,
                name: 'Expected',
                type: 'bar',
                marker: {color: 'rgb(140,140,140)'},
            };

            var trace2 = {
                x: Object.keys(result.namesMea),
                y: y2,
                name: 'Measured',
                type: 'bar',
                marker: {color: 'rgb(51,122,183)'},
            };

            var data = [trace1, trace2];

            var layout = {
                width: 600,
                height: 200,
                barmode: 'group',
                xaxis: {
                    autorange: true,
                    showgrid: false,
                    zeroline: true,
                    showline: false,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                },
                yaxis: {
                    autorange: true,
                    showgrid: false,
                    zeroline: false,
                    showline: false,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                },
                margin: {l: 20, r: 20, b: 40, t: 0, pad: 0},
                showlegend: false,
                barnorm: "fraction"
            };
            Plotly.newPlot('nameplot_' + result.id, data, layout);
        }
    }


    plot([[${results_score}]]);
    plot([[${covariants}]]);

    function plot(results) {
        var buttons_s = {};

        for (var j = 0; j < results.length; j++) {


            var x0 = results[j].scoresMea;
            var x1 = results[j].scoresExp;

            if (x0.length < 3 || x1.length < 3) {
                break;
            }

            var measured = {
                x: x0,
                marker: {color: 'rgb(51,122,183)'},
                opacity: 0.75,
                type: 'histogram',
                name: "measured"
            };

            var expected = {
                x: x1,
                opacity: 0.75,
                marker: {color: 'rgb(140,140,140)'},
                type: 'histogram',
                name: "expected"
            };
            var data_s = [measured, expected];

            var layout_s = {
                autosize: false,
                width: 400,
                height: 100,
                barmode: 'overlay',
                xaxis: {
                    autorange: true,
                    showgrid: true,
                    zeroline: true,
                    showline: false,
                    autotick: true,
                    ticks: ''
                },
                yaxis: {
                    autorange: true,
                    showgrid: false,
                    zeroline: false,
                    showline: false,
                    autotick: true,
                    ticks: '',
                    showticklabels: false
                },
                margin: {l: 0, r: 0, b: 15, t: 0, pad: 0}
            };


            if (results[j].name.startsWith("Distance from")) { //if is 'distance to' track
                layout_s.yaxis.type = 'log'
            }
            Plotly.newPlot("plot_" + results[j].id, data_s, layout_s, buttons_s);

        }
    }

    /*]]>*/

    /* Sequence logo stuff */


    var margin = {top: 10, right: 20, bottom: 30, left: 40},
        width = 560 - margin.left - margin.right,
        height = 170 - margin.top - margin.bottom;

    var x = d3.scale.ordinal()
        .rangeRoundBands([0, width], .1);

    var y = d3.scale.linear()
        .range([height, 0]);

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");

    var svg = d3.select("#sequencelogo").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    sequencelogoFont();

    var data = JSON.parse([[${sequencelogo}]]);

    data.forEach(function (d) {
        var y0 = 0;
        d.bits = d.map(function (entry) {
            return {bits: entry.bits, letter: entry.letter, y0: y0, y1: y0 += +entry.bits};
        })

        d.bitTotal = d.bits[d.bits.length - 1].y1;
    });

    x.domain(data.map(function (d, i) {
        return i;
    }));

    var maxBits = d3.max(data, function (d) {
        return d.bitTotal
    });

    y.domain([0, maxBits]);

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Bits");

    var column = svg.selectAll(".sequence-column")
        .data(data)
        .enter()
        .append("g")
        .attr("transform", function (d, i) {
            return "translate(" + (x(i) + (x.rangeBand() / 2)) + ",0)";
        })
        .attr("class", "sequence-column");

    var capHeightAdjust = 1.6; // approximation to bring cap-height to full font size

    column
        .selectAll("text")
        .data(function (d) {
            return d.bits;
        })
        .enter()
        .append("text")
        .attr("y", function (e) {
            return y(e.y0);
        })
        .text(function (e) {
            return e.letter;
        })
        .attr("class", function (e) {
            return "letter-" + e.letter;
        })
        .style("text-anchor", "middle")
        .style("font-family", "sequencelogo")
        .attr("textLength", x.rangeBand())
        .attr("lengthAdjust", "spacingAndGlyphs")
        .attr("font-size", function (e) {
            return ( y(e.y0) - y(e.y1) ) * capHeightAdjust;
        })
        .style("font-size", function (e) {
            return ( y(e.y0) - y(e.y1) ) * capHeightAdjust;
        })
    ;


    function sequencelogoFont() {
        var font = svg.append("defs").append("font")
            .attr("id", "sequencelogo")
            .attr("horiz-adv-x", "1000")
            .attr("vert-adv-y", "1000");

        font.append("font-face")
            .attr("font-family", "sequencelogo")
            .attr("units-per-em", "1000")
            .attr("ascent", "950")
            .attr("descent", "-50");

        font.append("glyph")
            .attr("unicode", "A")
            .attr("vert-adv-y", "50")
            .attr("d", "M500 767l-120 -409h240zM345 948h310l345 -1000h-253l-79 247h-338l-77 -247h-253l345 1000v0z");

        font.append("glyph")
            .attr("unicode", "C")
            .attr("vert-adv-y", "50")
            .attr("d", "M1000 -6q-75 -23 -158 -34.5t-175 -11.5q-325 0 -496 128.5t-171 370.5q0 244 171 372.5t496 128.5q92 0 176 -12t157 -35v-212q-82 46 -159 66q-77 22 -159 22q-174 0 -263 -84q-89 -82 -89 -246q0 -162 89 -246q89 -82 263 -82q82 0 159 20q77 22 159 67v-212v0z");

        font.append("glyph")
            .attr("unicode", "G")
            .attr("vert-adv-y", "50")
            .attr("d", "M745 141v184h-199v160h454v-442q-84 -47 -186 -71q-100 -24 -216 -24q-286 0 -442 129q-156 131 -156 370q0 244 157 372q158 129 455 129q89 0 175 -17q86 -16 161 -47v-211q-62 51 -141 77q-79 27 -174 27q-166 0 -248 -82t-82 -248q0 -160 79 -244t230 -84q45 0 79 5 q34 6 54 17v0z");

        font.append("glyph")
            .attr("unicode", "T")
            .attr("vert-adv-y", "50")
            .attr("d", "M640 -52h-280v827h-360v173h1000v-173h-360v-827v0z");
    }

</script>

</body>
</html>