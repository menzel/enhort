<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml">

<head lang="en">

    <title>Enhort</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <link rel="stylesheet" media="screen" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" media="screen" href="../static/css/result.css" th:href="@{/css/result.css}"/>
    <link rel="stylesheet" media="screen" href="../static/css/celllinetree.css" th:href="@{/css/celllinetree.css}"/>

    <script src="/js/plotly-latest.min.js" th:href="@{/js/plotly-latest.min.js}"></script>
    <script src="/js/jquery-1.12.0.min.js" th:href="@{/js/jquery-1.12.0.min.js}"></script>
    <script src="/js/bootstrap.min.js" th:href="@{/js/bootstrap.min.js}"></script>
    <script src="/js/d3.min.js" th:href="@{/js/d3.min.js}"></script>
    <script src="/js/result.js" th:href="@{/js/result.js}"></script>
    <script src="/js/zingchart.min.js" th:href="@{/js/zingchart.min.js}"></script>
</head>
<body>

<div th:include="header:: bar"></div>

<div class="col-xs-2 col-sm-2 col-md-2 sidebar">

    <th:block th:if="${ran}">

        <div class="box">
            <h4>Info</h4>


            <div class="fileinfo">
                <p th:text="${'Current File: ' + interfaceCommand.originalFilename}"></p>
                <span>Positions</span><span class="file_positions" th:text="${interfaceCommand.positionCount}"></span>
            </div>

            <div class="fileinfo">
                <p>
                    <a href="export/bg"><span>Background</span></a> <input type="number" step="200" form="covariate_form" th:field="*{interfaceCommand.minBg}"/>
                </p>
            </div>
        </div>

        <div class="box">
            <h4>Data</h4>

            <a id="changetracksbtn" class="btn btn-default" href="/wizfile">
                <span class="glyphicon glyphicon-th-list" aria-hidden="true"></span>
            </a>


            <a id="settingsbtn" class="btn btn-default" data-toggle="modal" data-target="#settings">
                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
            </a>

            <div class="box">

                <th:block th:if="${not #lists.isEmpty(customTracks)}">
                    <h4> Custom tracks </h4>
                </th:block>

                <th:block th:each="track: ${customTracks}">
                    <div class="checkbox">
                        <span th:text="${track.name}"></span>
                    </div>
                </th:block>

            </div>

            <th:block th:if="${ran}">
                <th:block th:if="${#lists.isEmpty(covariants)}">
                    <div th:include="uploadBg:: uploadbg"></div>
                </th:block>
            </th:block>

        </div>

        <div class="box">
            <h4>Results</h4>

            <a id="savebtn" class="btn btn-default extra-margin" href="export/csv">
                <span class="glyphicon glyphicon-save-file" aria-hidden="true"></span>
            </a>

            <a id="plotbtn" class="btn btn-default extra-margin" href="plot">
                <span class="glyphicon glyphicon-signal" aria-hidden="true"></span>
            </a>

        </div>

        <button id="rerun" type="submit" onclick="this.disabled=true;this.form.submit();" class="btn btn-primary"
                form="covariate_form">Run again
        </button>

        <a id="clearbtn" class="btn btn-default bottom" href="clear_session">
            <span class="glyphicon glyphicon-erase" aria-hidden="true"></span>
        </a>



    </th:block>

</div>


<div class="col-xs-10 col-xs-offset-2 col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">

    <div class="container row col-md-12">
        <th:block th:if="${ran}">

            <div class="col-md-8">

                <div id="hotspots">

                    <th:block th:if="${interfaceCommand.hotspots != null}">
                        <th:block th:each="pixel: ${interfaceCommand.hotspots}">
                            <div class="hotspot" th:style="'background-color:hsl(231,100%,' + ${pixel} + '%);'"></div>
                        </th:block>
                    </th:block>

                </div>
                <div id="plots">
                    <span id="hotspot_info" class="glyphicon glyphicon-info-sign" data-toggle="tooltip"
                          data-placement="right"
                          title="Hotspots across the genome. Lighter bars represent less integration sites while the highest integration site is shown in darker blue. See FAQ for more information."></span>


                    <form method="POST" action="#" th:action="@{/covariate}" th:object="${interfaceCommand}"
                          id="covariate_form"></form>

                    <div id="radarChart"></div>
                    <div id="scatterChart"></div>
                </div>


                <!-- Top plots end-->

                <!-- Result table -->

                <table class="table table-hover fixed">

                    <col width="160px"/>
                    <col width="50px"/>
                    <col width="70px"/>
                    <col width="150px"/>
                    <col width="30px"/>



                    <tbody>

                    <!-- Sequencelogo Entry -->
                    <th:block th:if="${ran}">
                        <th:block th:if="${interfaceCommand.logo}">
                            <th:block th:if="${not interfaceCommand.logoCovariate}">
                                <tr>
                                    <td data-target="#sequencelogodiv" data-toggle="collapse" class="accordion-toggle">
                                        Sequence Logo
                                    </td>
                                    <td></td>
                                    <td th:text="${sl_effect}"></td>
                                    <td colspan="1"></td>
                                    <td><input th:field="${interfaceCommand.logoCovariate}" type="checkbox"
                                               form="covariate_form"/></td>
                                </tr>
                                <tr>
                                    <td colspan="5" class="hiddenRow">
                                        <div class="accordion-body collapse" id="sequencelogodiv">

                                            <div id="sequencelogo"></div>
                                            <p th:text="${sequencelogo_name}"></p>

                                            <div id="sequencelogo2"></div>
                                            <p th:text="${sequencelogo2_name}"></p>
                                            The SequenceLogo with a width of 12 bases calculated using 3000 integration
                                            sites taken from the
                                            dataset.
                                        </div>
                                    </td>
                                </tr>
                            </th:block>
                        </th:block>
                    </th:block>
                    <!-- Sequencelogo Entry END -->


                    <!-- Annotation table -->
                    <!-- Annotation table inout -->
                    <tr>
                        <td data-toggle="tooltip" data-placement="right"
                            title="">
                            Annotation group
                        </td>

                        <td></td>
                        <td>Max effect size</td>
                        <td>Value distribution</td>
                    </tr>

                    <th:block th:each="package: ${results}">
                        <tr class="packrow">
                            <td th:text="${package.key}"
                                th:attr="data-target=${#strings.replace('#outer_'+package.key,' ','_')}"
                                data-toggle="collapse" class="accordion-toggle">
                            </td>
                            <td></td>
                            <td th:text="${efs.get(package.key).middle}"></td>
                            <td class="hammer">

                                <div class="ballgroup">
                                    <div class="ballbar"
                                         th:style="'margin-left:' + ${efs.get(package.key).left} + 'px;width:' + ${efs.get(package.key).right - efs.get(package.key).left} + 'px'"></div>
                                    <div class="ball"></div>
                                </div>

                            </td>
                            <td></td>
                        </tr>

                        <tr>
                            <td colspan="5" class="hiddenRow">
                                <div class="accordion-body collapse"
                                     th:id="${#strings.replace('outer_'+package.key,' ','_')}">

                                    <table class="table tracktable">

                                        <col width="120px"/>
                                        <col width="90px"/>
                                        <col width="90px"/>
                                        <col width="140px"/>
                                        <col width="20px"/>

                                        <tr>
                                            <td data-toggle="tooltip" data-placement="right"
                                                title="Count of significant tracks vs all tracks">
                                                Significant Tracks
                                            </td>

                                            <td data-toggle="tooltip" data-placement="right"
                                                title="P-value computed by chi-square-test">P Value
                                            </td>
                                            <td>Effect Size</td>
                                            <td>Relative Integration<span style="font-size: 10px;"> <span
                                                    style="color: #337ab7; font-size: 13px;">Data</span> vs. <span
                                                    style="color: #555; font-size: 13px;"> Background</span></span></td>
                                        </tr>


                                        <th:block th:each="result: ${package.value}">
                                            <tr class="trackrow">

                                                <td th:if="${result.track.cellLine != 'Unknown'}"
                                                    th:text="${result.name + ' (' + result.track.cellLine + ')'}"
                                                    th:attr="data-target=${#strings.replace('#accordion_' + result.id,'.','_')}"
                                                    data-toggle="collapse" class="accordion-toggle"></td>
                                                <td th:if="${result.track.cellLine == 'Unknown'}"
                                                    th:text="${result.name}"
                                                    th:attr="data-target=${#strings.replace('#accordion_' + result.id,'.','_')}"
                                                    data-toggle="collapse" class="accordion-toggle"></td>

                                                <td th:text="${result.pValue}"></td>
                                                <td th:text="${result.effectSize}"></td>
                                                <td class="bars">
                                                    <div class="bar measured"
                                                         th:style="'width: ' + ${result.percentInM} + '%;'"></div>
                                                    <div class="bar expected"
                                                         th:style="'width: ' + ${result.percentInE} + '%;'"></div>
                                                </td>
                                                <td><input th:field="*{interfaceCommand.covariants}"
                                                           th:value="${result.id}" type="checkbox"
                                                           form="covariate_form"/></td>
                                            </tr>
                                            <tr>
                                                <td colspan="5" class="hiddenRow">
                                                    <div class="accordion-body collapse trackbox"
                                                         th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                                        <div>
                                                            <table class="table dattable">
                                                                <thead>
                                                                <th></th>
                                                                <th class="bold">In</th>
                                                                <th class="bold">Out</th>
                                                                </thead>
                                                                <tr class="datrow">
                                                                    <td class="bold"
                                                                        th:text="${interfaceCommand.originalFilename}"></td>
                                                                    <td th:text="${result.measuredIn + ' (' + result.percentInM + '%)'}"></td>
                                                                    <td th:text="${result.measuredOut+ ' (' + result.percentOutM+ '%)'}"></td>
                                                                </tr>
                                                                <tr class="datrow">
                                                                    <td class="bold" th:text="${bgfilename}"></td>
                                                                    <td th:text="${result.expectedIn+ ' (' + result.percentInE + '%)'}"></td>
                                                                    <td th:text="${result.expectedOut+ ' (' + result.percentOutE+ '%)'}"></td>
                                                                </tr>
                                                            </table>
                                                        </div>
                                                        <div class="desc" th:text="${result.description}"></div>
                                                    </div>
                                                </td>
                                            </tr>

                                        </th:block>
                                    </table>
                                </div>
                            </td>
                        </tr>

                    </th:block>

                    <!-- Annotation table scored -->

                    <tr class="packrow">
                        <td data-target="#scored_body" data-toggle="collapse" class="accordion-toggle">
                            Expression Scores
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse"
                                 th:id="scored_body">
                                <table class="table tracktable">

                                    <col width="120px"/>
                                    <col width="90px"/>
                                    <col width="90px"/>
                                    <col width="140px"/>
                                    <col width="20px"/>

                                    <tr>
                                        <td data-toggle="tooltip" data-placement="right"
                                            title="TODO">
                                            Significant Tracks
                                        </td>

                                        <td data-toggle="tooltip" data-placement="right"
                                            title="P-value computed by chi-square-test">P Value
                                        </td>
                                        <td>Effect Size</td>
                                        <td>Relative Integration<span style="font-size: 10px;"> <span
                                                style="color: #337ab7; font-size: 13px;">Data</span> vs. <span
                                                style="color: #555; font-size: 13px;"> Background</span></span></td>
                                    </tr>

                                    <th:block th:each="result: ${results_score}">
                                        <tr th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}"
                                            data-toggle="collapse" class="accordion-toggle">
                                            <td th:text="${result.name}"></td>
                                            <td th:text="${result.pValue}"></td>
                                            <td th:text="${result.effectSize}"></td>
                                            <td th:id="${'plot_'+result.id}"></td>
                                            <th:block
                                                    th:if="${not #strings.startsWith(result.name,'FOOBAR Distance from')}">
                                                <!-- only display a checkbox for covariates if it is not a _distance_ track -->
                                                <td><input th:field="*{interfaceCommand.covariants}"
                                                           th:value="${result.id}"
                                                           type="checkbox"
                                                           form="covariate_form"/></td>
                                            </th:block>
                                        </tr>
                                        <tr>
                                            <td colspan="5" class="hiddenRow">
                                                <div class="accordion-body collapse"
                                                     th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                                    <div class="desc" th:text="${result.description}"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </th:block>

                                </table>
                            </div>
                        </td>
                    </tr>

                    <!-- Annotation table named -->

                    <tr class="packrow">
                        <td data-target="#named_body" data-toggle="collapse" class="accordion-toggle">
                            Named tracks
                        </td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td colspan="5" class="hiddenRow">
                            <div class="accordion-body collapse" id=named_body>

                                <table class="table tracktable">

                                    <col width="120px"/>
                                    <col width="90px"/>
                                    <col width="90px"/>
                                    <col width="140px"/>
                                    <col width="20px"/>

                                    <tr>
                                        <td data-toggle="tooltip" data-placement="right"
                                            title="TODO">
                                            Significant Tracks
                                        </td>

                                        <td data-toggle="tooltip" data-placement="right"
                                            title="P-value computed by chi-square-test">P Value
                                        </td>
                                        <td>Effect Size</td>
                                        <td>Relative Integration<span style="font-size: 10px;"> <span
                                                style="color: #337ab7; font-size: 13px;">Data</span> vs. <span
                                                style="color: #555; font-size: 13px;"> Background</span></span></td>
                                    </tr>


                                    <th:block th:each="result: ${results_named}">
                                        <tr th:attr="data-target=${#strings.replace('#accordion_'+result.id,'.','_')}"
                                            data-toggle="collapse" class="accordion-toggle">
                                            <td th:text="${result.name}"></td>
                                            <td th:text="${result.pValue}"></td>
                                            <td th:text="${result.effectSize}"></td>
                                            <td th:id="${result.id}"></td>
                                            <td><input th:field="*{interfaceCommand.covariants}" th:value="${result.id}"
                                                       type="checkbox"
                                                       form="covariate_form"/></td>
                                        </tr>
                                        <tr>
                                            <td colspan="5" class="hiddenRow">
                                                <div class="accordion-body collapse"
                                                     th:id="${#strings.replace('accordion_'+result.id,'.','_')}">
                                                    <div class="nameplot" th:id="${'nameplot_'+result.id}">
                                                        <div th:value="${result.namesMea}"></div>
                                                        <div th:value="${result.namesExp}"></div>
                                                    </div>
                                                    <div class="desc" th:text="${result.description}"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </th:block>
                                </table>
                            </div>
                        </td>
                    </tr>


                    </tbody>
                </table>


                <!-- Result table end -->

                <th:block th:if="${ran}">
                    <tr> <!-- create or upload custom track button -->
                        <td class="add" colspan="5" data-placement="right" title="Upload custom track"
                            data-toggle="tooltip">
                            <button type="button" class="btn btn-default" data-toggle="modal"
                                    data-target="#add_track">
                                &#43;
                            </button>
                        </td>
                    </tr>
                </th:block>


            </div>
            <div class="col-md-4">

                <!-- Covariates column (right) -->

                <div class="bg-info" th:if="${bgfilename != 'Background'}">
                    Background sites are taken from the uploaded file <span th:text="${bgfilename}"></span>
                </div>

                <table class="table table-hover fixed" th:if="${bgfilename == 'Background'}">

                    <col width="400px"/>
                    <col width="30px"/>
                    <thead>
                    <th th:text="${'Covariates' + ' (' + covariantCount + ')'}">Covariates</th>
                    </thead>
                    <tbody>

                    <th:block th:if="${interfaceCommand.logoCovariate}">
                        <tr>
                            <td data-target="#sequencelogodiv" data-toggle="collapse" class="accordion-toggle">
                                Sequence Logo
                            </td>
                            <td><input th:field="${interfaceCommand.logoCovariate}" type="checkbox"
                                       form="covariate_form"/>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5" class="hiddenRow">
                                <div class="accordion-body collapse" id="sequencelogodiv">

                                    <div id="sequencelogo"></div>
                                    <p th:text="${sequencelogo_name}"></p>

                                    <div id="sequencelogo2"></div>
                                    <p th:text="${sequencelogo2_name}"></p>

                                    The Sequence or Weblogo with a width of 12 bases of 3000 sequences taken from the
                                    dataset.
                                </div>
                            </td>
                        </tr>

                    </th:block>


                    <th:block th:each="cov: ${covariants}">
                        <tr>
                            <td th:text="${cov.name}"
                                th:attr="data-target=${#strings.replace('#accordion_cov_' + cov.id,'.','_')}"
                                data-toggle="collapse" class="accordion-toggle"></td>
                            <td><input th:field="*{interfaceCommand.covariants}" th:value="${cov.id}" type="checkbox"
                                       form="covariate_form" class="checked" checked="checked"/></td>
                        </tr>
                        <tr>
                            <td colspan="2" class="hiddenRow">
                                <div class="accordion-body collapse"
                                     th:id="${#strings.replace('accordion_cov_' + cov.id,'.','_')}">
                                    <div>
                                        <div>
                                            <table class="table">


                                                <thead>
                                                <th></th>
                                                <th class="bold">In</th>
                                                <th class="bold">Out</th>
                                                </thead>
                                                <tr class="">
                                                    <td class="bold"
                                                        th:text="${interfaceCommand.originalFilename}"></td>
                                                    <td th:text="${cov.measuredIn + ' (' + cov.percentInM + '%)'}"></td>
                                                    <td th:text="${cov.measuredOut+ ' (' + cov.percentOutM+ '%)'}"></td>
                                                </tr>
                                                <tr class="">
                                                    <td class="bold" th:text="${bgfilename}"></td>
                                                    <td th:text="${cov.expectedIn+ ' (' + cov.percentInE + '%)'}"></td>
                                                    <td th:text="${cov.expectedOut+ ' (' + cov.percentOutE+ '%)'}"></td>
                                                </tr>
                                                <tr>
                                                    <td>P Value</td>
                                                    <td th:text="${cov.pValue}"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="3" th:id="${'plot_'+cov.id}"></td>
                                                    <td colspan="3" th:id="${'nameplot_'+cov.id}"></td>
                                                </tr>
                                            </table>

                                        </div>
                                    </div>
                                </div>
                            </td>


                        </tr>


                    </th:block>

                    </tbody>

                </table>

            </div>


        </th:block>
    </div><!-- /.container -->

    <!-- Modal for add/upload track -->
    <div th:include="add_track:: add_track"></div>

    <!-- Modal Settings -->
    <div class="modal fade" id="settings" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Settings</h4>
                </div>
                <div class="modal-body">
                    <div>
                        <p>
                        <label>
                            <input th:field="*{interfaceCommand.showall}" type="checkbox" form="covariate_form"/>
                            Disable P Value filter
                        </label>
                        </p>
                        <p>
                            <a href="export/bg"><span>Download background positions<span
                                    class="glyphicon glyphicon-link"></span></span></a>
                        </p>


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary" form="covariate_form">Run again</button>
                </div>
            </div>
        </div>
    </div>
    <!--End settings modeal -->

    <th:block th:if="${ran == null}">
        <div id="new" class="bg-info">
            <h3> New to Enhort? </h3>
            <p>Go to <a href="/faq">FAQ</a> and find out how to work with the application.</p>
            <p>Or begin using Enhort with the <a href="/wiz">wizard</a></p>

            <p>If you know what you are doing upload a file and get started.</p>
        </div>
    </th:block>


    <th:block th:if="${ran != null}">
        <th:block th:if="${interfaceCommand.positionCount < 1}">
            <div id="new" class="bg-warning">
                <h3> No positions in your file </h3>
                <p>There are no genomic positions in the .bed file you uploaded. </p>
                <p>Does it have the correct format, example: chr1\t10\t100 (where \t is a tab)</p>
            </div>
        </th:block>
    </th:block>
</div>

<script th:inline="javascript" async="async">
    /*<![CDATA[*/
    'use strict';

    //disable all checkboxes if there is an uploaded bg file
    if([[${bgfilename }]] !== "Background"){
        $("input[type='checkbox']").each(function (id, box) {
            box.disabled = true;
        });
    }
</script>

<script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip({
            container: 'body'

        });
    });

    $('.checked').prop('checked', true);

</script>

<script th:inline="javascript" async="async">
    /*<![CDATA[*/
    'use strict';

    if ([[${results_named}]] !== null) {

        plotNames([[${results_named}]]);
        plotNames([[${covariants}]]);
    }


    if ([[${results_score}]] !== null) {
        plot([[${results_score}]]);
        plot([[${covariants}]]);
    }

    /*]]>*/

    /* Sequence logo stuff */

    if ([[${sequencelogo}]] !== null) {
        setSequenceLogo([[${sequencelogo}]], "#sequencelogo");
        setSequenceLogo([[${sequencelogo2}]], "#sequencelogo2");
    }

</script>


<script th:inline="javascript" async="async">
    /*<![CDATA[*/
    'use strict';

    plotRadar([[${efs}]]);
    plotBubble([[${pca_names}]], [[${pca}]]);

</script>

</body>
</html>
